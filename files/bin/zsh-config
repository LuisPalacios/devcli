#!/bin/bash
# Script para configurar características específicas del .zshrc
# Uso: zsh-config [opción]

set -e

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Función para mostrar ayuda
show_help() {
    cat << EOF
Uso: zsh-config [OPCIÓN]

Opciones:
  --wsl2-enable     Habilitar características específicas de WSL2
  --wsl2-disable    Deshabilitar características específicas de WSL2
  --macos-enable    Habilitar características específicas de macOS
  --macos-disable   Deshabilitar características específicas de macOS
  --linux-enable    Habilitar características específicas de Linux
  --linux-disable   Deshabilitar características específicas de Linux
  --tmux-enable     Habilitar alias de tmux
  --tmux-disable    Deshabilitar alias de tmux
  --nextcloud-enable  Habilitar rutas de Nextcloud
  --nextcloud-disable Deshabilitar rutas de Nextcloud
  --help            Mostrar esta ayuda

Ejemplos:
  zsh-config --wsl2-enable
  zsh-config --macos-disable
  zsh-config --tmux-enable
EOF
}

# Función para detectar sistema operativo
detect_os() {
    if [[ -n "$WSL_DISTRO_NAME" ]]; then
        echo "wsl2"
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macos"
    else
        echo "linux"
    fi
}

# Función para modificar .zshrc
modify_zshrc() {
    local action="$1"
    local pattern="$2"
    local replacement="$3"
    local zshrc_file="$HOME/.zshrc"
    
    if [[ ! -f "$zshrc_file" ]]; then
        echo -e "${RED}Error: No se encontró $zshrc_file${NC}"
        return 1
    fi
    
    case "$action" in
        "comment")
            # Comentar líneas que coincidan con el patrón
            sed -i "/^[[:space:]]*$pattern/s/^/# /" "$zshrc_file"
            echo -e "${GREEN}Comentadas las líneas que coinciden con: $pattern${NC}"
            ;;
        "uncomment")
            # Descomentar líneas que coincidan con el patrón
            sed -i "/^[[:space:]]*# $pattern/s/^# //" "$zshrc_file"
            echo -e "${GREEN}Descomentadas las líneas que coinciden con: $pattern${NC}"
            ;;
        "replace")
            # Reemplazar patrón con reemplazo
            sed -i "s|$pattern|$replacement|g" "$zshrc_file"
            echo -e "${GREEN}Reemplazado: $pattern -> $replacement${NC}"
            ;;
    esac
}

# Función para configurar WSL2
configure_wsl2() {
    local enable="$1"
    
    if [[ "$enable" == "true" ]]; then
        echo -e "${BLUE}Habilitando características de WSL2...${NC}"
        
        # Descomentar rutas de WSL2
        modify_zshrc "uncomment" '"/mnt/c/Users/\${SOY}/Nextcloud/priv/bin"'
        modify_zshrc "uncomment" '"/mnt/c/Users/\${SOY}/Nextcloud/priv/bin/win"'
        modify_zshrc "uncomment" '"/mnt/c/Users/\${SOY}/dev-tools/kombine.win"'
        modify_zshrc "uncomment" '"/mnt/c/Users/\${SOY}/AppData/Local/Programs/Microsoft VS Code/bin"'
        modify_zshrc "uncomment" '"/mnt/c/Program Files/Docker/Docker/resources/bin"'
        modify_zshrc "uncomment" '"/mnt/c/Program Files/Git/mingw64/bin"'
        modify_zshrc "uncomment" '"/mnt/c/Windows/System32"'
        modify_zshrc "uncomment" '"/mnt/c/Windows"'
        modify_zshrc "uncomment" '"/mnt/c/Windows/System32/wbem"'
        modify_zshrc "uncomment" '"/mnt/c/Windows/System32/WindowsPowerShell/v1.0"'
        modify_zshrc "uncomment" '"/mnt/c/Program Files/PowerShell/7"'
        
        # Descomentar alias específicos
        modify_zshrc "uncomment" 'alias c="cd /mnt/c/Users/\${SOY}"'
        modify_zshrc "uncomment" 'alias git="git.exe"'
        
        echo -e "${GREEN}Características de WSL2 habilitadas${NC}"
    else
        echo -e "${BLUE}Deshabilitando características de WSL2...${NC}"
        
        # Comentar rutas de WSL2
        modify_zshrc "comment" '"/mnt/c/Users/\${SOY}/Nextcloud/priv/bin"'
        modify_zshrc "comment" '"/mnt/c/Users/\${SOY}/Nextcloud/priv/bin/win"'
        modify_zshrc "comment" '"/mnt/c/Users/\${SOY}/dev-tools/kombine.win"'
        modify_zshrc "comment" '"/mnt/c/Users/\${SOY}/AppData/Local/Programs/Microsoft VS Code/bin"'
        modify_zshrc "comment" '"/mnt/c/Program Files/Docker/Docker/resources/bin"'
        modify_zshrc "comment" '"/mnt/c/Program Files/Git/mingw64/bin"'
        modify_zshrc "comment" '"/mnt/c/Windows/System32"'
        modify_zshrc "comment" '"/mnt/c/Windows"'
        modify_zshrc "comment" '"/mnt/c/Windows/System32/wbem"'
        modify_zshrc "comment" '"/mnt/c/Windows/System32/WindowsPowerShell/v1.0"'
        modify_zshrc "comment" '"/mnt/c/Program Files/PowerShell/7"'
        
        # Comentar alias específicos
        modify_zshrc "comment" 'alias c="cd /mnt/c/Users/\${SOY}"'
        modify_zshrc "comment" 'alias git="git.exe"'
        
        echo -e "${GREEN}Características de WSL2 deshabilitadas${NC}"
    fi
}

# Función para configurar macOS
configure_macos() {
    local enable="$1"
    
    if [[ "$enable" == "true" ]]; then
        echo -e "${BLUE}Habilitando características de macOS...${NC}"
        
        # Descomentar rutas de macOS
        modify_zshrc "uncomment" '"${HOME}/Nextcloud/priv/bin"'
        modify_zshrc "uncomment" '"${HOME}/dev-tools/kombine.osx"'
        modify_zshrc "uncomment" 'alias e="/usr/local/bin/code"'
        
        echo -e "${GREEN}Características de macOS habilitadas${NC}"
    else
        echo -e "${BLUE}Deshabilitando características de macOS...${NC}"
        
        # Comentar rutas de macOS
        modify_zshrc "comment" '"${HOME}/Nextcloud/priv/bin"'
        modify_zshrc "comment" '"${HOME}/dev-tools/kombine.osx"'
        modify_zshrc "comment" 'alias e="/usr/local/bin/code"'
        
        echo -e "${GREEN}Características de macOS deshabilitadas${NC}"
    fi
}

# Función para configurar Linux
configure_linux() {
    local enable="$1"
    
    if [[ "$enable" == "true" ]]; then
        echo -e "${BLUE}Habilitando características de Linux...${NC}"
        
        # Descomentar rutas de Linux
        modify_zshrc "uncomment" '"${HOME}/Nextcloud/priv/bin"'
        
        echo -e "${GREEN}Características de Linux habilitadas${NC}"
    else
        echo -e "${BLUE}Deshabilitando características de Linux...${NC}"
        
        # Comentar rutas de Linux
        modify_zshrc "comment" '"${HOME}/Nextcloud/priv/bin"'
        
        echo -e "${GREEN}Características de Linux deshabilitadas${NC}"
    fi
}

# Función para configurar tmux
configure_tmux() {
    local enable="$1"
    
    if [[ "$enable" == "true" ]]; then
        echo -e "${BLUE}Habilitando alias de tmux...${NC}"
        
        # Descomentar alias de tmux
        modify_zshrc "uncomment" 'alias t="exec ~/Nextcloud/priv/bin/t"'
        modify_zshrc "uncomment" 'alias tt="~/Nextcloud/priv/bin/t"'
        
        echo -e "${GREEN}Alias de tmux habilitados${NC}"
    else
        echo -e "${BLUE}Deshabilitando alias de tmux...${NC}"
        
        # Comentar alias de tmux
        modify_zshrc "comment" 'alias t="exec ~/Nextcloud/priv/bin/t"'
        modify_zshrc "comment" 'alias tt="~/Nextcloud/priv/bin/t"'
        
        echo -e "${GREEN}Alias de tmux deshabilitados${NC}"
    fi
}

# Función para configurar Nextcloud
configure_nextcloud() {
    local enable="$1"
    local current_os=$(detect_os)
    
    if [[ "$enable" == "true" ]]; then
        echo -e "${BLUE}Habilitando rutas de Nextcloud...${NC}"
        
        case "$current_os" in
            "wsl2")
                modify_zshrc "uncomment" '"/mnt/c/Users/\${SOY}/Nextcloud/priv/bin"'
                modify_zshrc "uncomment" '"/mnt/c/Users/\${SOY}/Nextcloud/priv/bin/win"'
                ;;
            "macos")
                modify_zshrc "uncomment" '"${HOME}/Nextcloud/priv/bin"'
                ;;
            "linux")
                modify_zshrc "uncomment" '"${HOME}/Nextcloud/priv/bin"'
                ;;
        esac
        
        echo -e "${GREEN}Rutas de Nextcloud habilitadas${NC}"
    else
        echo -e "${BLUE}Deshabilitando rutas de Nextcloud...${NC}"
        
        case "$current_os" in
            "wsl2")
                modify_zshrc "comment" '"/mnt/c/Users/\${SOY}/Nextcloud/priv/bin"'
                modify_zshrc "comment" '"/mnt/c/Users/\${SOY}/Nextcloud/priv/bin/win"'
                ;;
            "macos")
                modify_zshrc "comment" '"${HOME}/Nextcloud/priv/bin"'
                ;;
            "linux")
                modify_zshrc "comment" '"${HOME}/Nextcloud/priv/bin"'
                ;;
        esac
        
        echo -e "${GREEN}Rutas de Nextcloud deshabilitadas${NC}"
    fi
}

# Main
main() {
    if [[ $# -eq 0 ]]; then
        show_help
        exit 1
    fi
    
    case "$1" in
        --wsl2-enable)
            configure_wsl2 true
            ;;
        --wsl2-disable)
            configure_wsl2 false
            ;;
        --macos-enable)
            configure_macos true
            ;;
        --macos-disable)
            configure_macos false
            ;;
        --linux-enable)
            configure_linux true
            ;;
        --linux-disable)
            configure_linux false
            ;;
        --tmux-enable)
            configure_tmux true
            ;;
        --tmux-disable)
            configure_tmux false
            ;;
        --nextcloud-enable)
            configure_nextcloud true
            ;;
        --nextcloud-disable)
            configure_nextcloud false
            ;;
        --help)
            show_help
            ;;
        *)
            echo -e "${RED}Opción desconocida: $1${NC}"
            show_help
            exit 1
            ;;
    esac
    
    echo -e "${YELLOW}Recarga tu shell con 'source ~/.zshrc' para aplicar los cambios${NC}"
}

main "$@" 